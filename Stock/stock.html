<!--
Copyright 2012 The Toolkitchen Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->
<element name="x-stock" attributes="symbol autoupdate">
  <link rel="components" href="../../toolkit/src/g-component.html">
  <link rel="components" href="../../toolkit/src/g-ajax.html">
  <template>
    <style>
      @host {
        display: inline-block;
        -webkit-box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        padding: 20px;
      }
      
      .stock-label {
        font-family: arial,sans-serif;
        font-size: medium;
        font-weight: lighter;
        color: #878787;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .large {
        font-size: x-large;
      }
      
      .small {
        font-size: small;
      }
      
      .stock-desc {
        text-transform: uppercase;
      }
      
      .quote {
        margin-top: 10px;
      }
      
      .price {
        color: #212121;
        margin-right: 10px;
      }
      
      .change {
        color: #3d9400;
      }
      
      .change.down {
        color: #dd4b39;
      }
      
      .more {
        margin-top: 20px;
        display: -webkit-box;
      }
      
      .chart {
        margin-right: 20px;
      }
      
      .details {
        width: 120px;
      }
      
      .details > * {
        line-height: 1.4;
      }
      
      .details > * > :first-child {
        display: inline-block;
        width: 60px;
      }
      
      @media screen and (max-width: 520px) {
        .details {
          display: none;
        }
      }
    </style>
    <div class="stock-label large">{{response.company.data}}</div>
    <div class="stock-label stock-desc">{{response.exchange.data}}: {{symbol}}</div>
    <div class="stock-label large quote">
      <span class="price">{{response.last.data}}</span>
      <span class="change {{change}}">{{response.change.data}} ({{response.perc_change.data}}%)</span>
    </div>
    <div class="more">
      <div class="chart">
        <img src="https://www.google.com/finance/chart?q={{response.exchange.data}}:{{symbol}}&amp;tlf=12&amp;chst=vks&amp;p=1d&amp;chs=327x96&amp;chsc=1&amp;nocache={{random}}" />
      </div>
      <div class="stock-label small details">
        <div><label>Open</label>{{response.open.data}}</div>
        <div><label>High</label>{{response.high.data}}</div>
        <div><label>Low</label>{{response.low.data}}</div>
        <div><label>Volume</label>{{response.volume.data}}</div>
        <div><label>Avg Vol</label>{{response.avg_volume.data}}000</div>
        <div><label>Mkt Cap</label>{{mktCap}}</div>
      </div>
    </div>
    <g-ajax id="ajax" handleAs="json" response="{{ajaxResponse}}"></g-ajax>
  </template>
  <script>
    this.component({
      publish: {
        updateinterval: 300000
      },
      ready: function() {
        this.go();
      },
      go: function() {
        this.$.ajax.url = 'http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20google.igoogle.stock%20where%20stock%3D"' + this.symbol + '"%3B&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys';
        this.$.ajax.go();
      },
      autoupdateChanged: function() {
        if (this.autoupdate) {
          this.intervalId = setInterval(this.go.bind(this), this.updateinterval);
        } else if (this.intervalId) {
          clearInterval(this.intervalId);
        }
      },
      ajaxResponseChanged: function(e, inDetail) {
        var results = this.ajaxResponse.query.results;
        if (results) {
          var r = this.response = results.xml_api_reply.finance;
          this.random = Math.random() * 10000;
          this.change = Number(r.change.data) > 0 ? 'up' : 'down';
          this.mktCap = (r.market_cap.data / 1000).toFixed(2) + 'B';
        }
      }
    });
  </script>
</element>

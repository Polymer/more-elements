<!--
Copyright 2013 The Toolkitchen Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->
<element name="yt-video" attributes="videoid">
  <template>
    <div id="container"></div>
  </template>
  <script>
    var ytListeners = [];
    pollForYoutubeApi = function() {
      setTimeout(function() {
        if (!(window.YT && window.YT.Player)) {
          pollForYoutubeApi();
        } else {
          youtubeApiReady();
        }
      }, 100);
    }
    
    function youtubeApiReady() {
      ytListeners.forEach(function(l) {
        l.videoidChanged();
      });
    }
    
    Toolkit.register(this, {
      YT_URL: 'http://www.youtube.com/player_api',
      videoid: null,
      videoidChanged: function() {
        if (this.videoid && this.videoid !== true) {
          if (this.player) {
           this.player.loadVideoById(this.videoid);
          } else {
           this.createPlayer();
          }
        }
      },
      createPlayer: function() {
        if (!window.YT) {
          this.loadYtApi();
          return;
        }
        this.player = new YT.Player(this.$.container, {
          height: '100%',
          width: '100%',
          events: {
            onReady: this.playerReady.bind(this),
            onStateChange: this.playerStateChange.bind(this)
          }
        });
        if (this.playerNode) {
          this.playerNode.hidden = true;
        }
      },
      playerReady: function(inEvent) {
        this.playerNode.hidden = true;
        this.player.loadVideoById(this.videoid);
        this.player.playVideo();
        // make player iframe fittable to this component.
        this.playerNode.style.position = "absolute";
      },
      playerStateChange: function(inEvent) {
        if (inEvent.data == 1) {
          this.playerNode.hidden = false;
        }
      },
      get playerNode() {
        return this.player && this.player.a;
      },
      loadYtApi: function() {
        if (!document.querySelector('[src="' + this.YT_URL + '"]')) {
          var s = document.createElement('script');
          s.src = this.YT_URL;
          document.head.appendChild(s);
          pollForYoutubeApi();
        }
        ytListeners.push(this);
      }
    });
  </script>
</element>
